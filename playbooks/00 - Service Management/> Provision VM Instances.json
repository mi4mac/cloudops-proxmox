{
    "@context": "/api/3/contexts/Workflow",
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "> Provision VM Instances",
    "aliasName": null,
    "tag": null,
    "description": "Create VM Instances",
    "isActive": true,
    "debug": true,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "vm_instance"
    ],
    "synchronous": false,
    "collection": "/api/3/workflow_collections/f1c80355-697f-4a71-971b-0988c871491d",
    "versions": [],
    "triggerStep": "/api/3/workflow_steps/ddf613c4-f071-4617-8431-e95140782d66",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Compute Available Resource",
            "description": null,
            "arguments": {
                "available_ram": "{{(vars.steps.Get_Available_Resources.data|split(\"\\r\\n\"))[1]}}",
                "available_disk": "{{(vars.steps.Get_Available_Resources.data|split(\"\\r\\n\"))[0]}}"
            },
            "status": null,
            "top": "435",
            "left": "300",
            "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "be041f7e-13b3-45be-b635-615bacaa0ab3"
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "vm_name": "{{vars.input.records[0].name}}",
                "vm_ip_address": "{{vars.input.records[0].networkInterfaces.iPAddress}}",
                "minimum_ram_mb": "1500",
                "minimum_disk_gb": "3",
                "cpu_cores": "{{vars.input.records[0].cpuCores or 2}}",
                "memory_mb": "{{vars.input.records[0].memoryMB or 2048}}",
                "disk_gb": "{{vars.input.records[0].diskGB or 20}}",
                "swap_mb": "{{vars.input.records[0].swapMB or 0}}",
                "root_password": "{{vars.input.records[0].rootPassword or 'fortinet'}}",
                "requestor_email": "{{vars.input.records[0].requestor.email}}",
                "available_resources": "df -BG --output=avail / | tail -n 1 | sed \"s/G//\" | tr -d \" \";free -m | awk '/^Mem:/ {print $7}'",
                "infrastructure_team_email": "{{globalVars.infrastructure_team_email or \"cloud-ops@fortielab.com\"}}"
            },
            "status": null,
            "top": "165",
            "left": "300",
            "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "83a26daa-be4b-4fc6-85a4-2d0e218b0058"
        },
        {
            "@type": "WorkflowStep",
            "name": "Deployment Successful",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "yes",
                        "step_iri": "/api/3/workflow_steps/97cf4809-7922-4322-b4cd-b1d11b9c6afd",
                        "condition": "{{ \"provisioned successfully\" in vars.cmd_result }}",
                        "step_name": "Update VM Instance Success"
                    },
                    {
                        "option": "no",
                        "default": true,
                        "step_iri": "/api/3/workflow_steps/bd1c98fb-4bd1-4894-b59f-a9d5acae6e17",
                        "step_name": "Update VM Instance Failure"
                    }
                ],
                "step_variables": []
            },
            "status": null,
            "top": "1110",
            "left": "465",
            "stepType": "/api/3/workflow_step_types/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "20d7f4c6-b288-4fc7-bbf7-85ffe5a599cb"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Available Resources",
            "description": null,
            "arguments": {
                "name": "SSH",
                "config": "36787c2e-5ae6-4a55-a4f9-de80281aa40e",
                "params": {
                    "cmd": "{{vars.available_resources}}",
                    "allowed_exit": "-1,0",
                    "is_super_user": false
                },
                "version": "2.1.3",
                "connector": "ssh",
                "operation": "run_remote_command",
                "operationTitle": "Execute remote command",
                "pickFromTenant": false,
                "step_variables": []
            },
            "status": null,
            "top": "300",
            "left": "300",
            "stepType": "/api/3/workflow_step_types/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "6ddbc282-5195-4ce0-9da9-c08de9541419"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get CMD Results",
            "description": null,
            "arguments": {
                "cmd_result": "{{vars.steps.Run_Provisioning_CMD.data or vars.steps.Run_Provisioning_CMD['Error message'] or vars.steps.Run_Provisioning_CMD.error or vars.steps.Run_Provisioning_CMD.output or 'No output captured'}}"
            },
            "status": null,
            "top": "975",
            "left": "465",
            "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "3463c10e-af17-40cf-b06e-93b967652dc2"
        },
        {
            "@type": "WorkflowStep",
            "name": "Notify Failure",
            "description": null,
            "arguments": {
                "config": "88c3d39c-2fa9-4731-b00d-29815008f17c",
                "params": {
                    "body": "<p>Dear {{vars.input.records[0].requestor.firstname}}</p>\n<p>An error occurred while processing request ID:&nbsp;<span style=\"color: rgb(230, 126, 35);\"><strong>{{vars.input.records[0].id}}</strong></span>.</p>\n<p>&nbsp;The Cloud Operations team has been notified and will address the issue shortly.</p>\n<p>&nbsp;</p>\n<p>Cloud Ops Team</p>",
                    "subject": "VM Instance Request Provisioning Failure",
                    "iri_list": "",
                    "cc_recipients": "{{vars.infrastructure_team_email}}",
                    "to_recipients": "{{vars.input.records[0].requestor.email}}",
                    "bcc_recipients": ""
                },
                "version": "2.6.0",
                "from_str": "admin@example.com",
                "connector": "smtp",
                "operation": "send_email",
                "operationTitle": "Send Email",
                "step_variables": []
            },
            "status": null,
            "top": "1380",
            "left": "125",
            "stepType": "/api/3/workflow_step_types/4c0019b2-055c-44d0-968c-678a0c2d762e",
            "group": null,
            "uuid": "92940054-3698-4b5d-a027-bfb98f1c4e80"
        },
        {
            "@type": "WorkflowStep",
            "name": "Notify Success",
            "description": null,
            "arguments": {
                "config": "88c3d39c-2fa9-4731-b00d-29815008f17c",
                "params": {
                    "body": "<p>Dear {{vars.input.records[0].requestor.firstname}}</p>\n<p>Your VM Instance has been provisioned successfully</p>\n<ul>\n<li>Host: {{vars.vm_ip_address}}</li>\n<li>Username: sysadmin</li>\n<li>Password: fortinet</li>\n</ul>\n<p>&nbsp;</p>\n<p>Cloud Ops Team</p>",
                    "subject": "VM Instance Request Provisioning Failure",
                    "iri_list": "",
                    "cc_recipients": "{{vars.infrastructure_team_email}}",
                    "to_recipients": "{{vars.input.records[0].requestor.email}}",
                    "bcc_recipients": ""
                },
                "version": "2.6.0",
                "from_str": "admin@example.com",
                "connector": "smtp",
                "operation": "send_email",
                "operationTitle": "Send Email",
                "step_variables": []
            },
            "status": null,
            "top": "1380",
            "left": "475",
            "stepType": "/api/3/workflow_step_types/4c0019b2-055c-44d0-968c-678a0c2d762e",
            "group": null,
            "uuid": "03054abf-333f-40a5-b97e-f626d392ace9"
        },
        {
            "@type": "WorkflowStep",
            "name": "Proxmox Node Resources Available",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "yes",
                        "step_iri": "/api/3/workflow_steps/39791b84-d705-4e0a-9cbe-048043a33c2b",
                        "condition": "{{ vars.available_disk >= vars.minimum_disk_gb and vars.available_ram >= vars.minimum_ram_mb }}",
                        "step_name": "Set Provisioning Params"
                    },
                    {
                        "option": "no",
                        "default": true,
                        "step_iri": "/api/3/workflow_steps/bd1c98fb-4bd1-4894-b59f-a9d5acae6e17",
                        "step_name": "Update VM Instance Failure"
                    }
                ],
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "300",
            "stepType": "/api/3/workflow_step_types/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "a19a6a2b-df4b-4306-85ea-4a0f37402012"
        },
        {
            "@type": "WorkflowStep",
            "name": "Run Provisioning CMD",
            "description": null,
            "arguments": {
                "name": "SSH",
                "config": "36787c2e-5ae6-4a55-a4f9-de80281aa40e",
                "params": {
                    "cmd": "{{vars.provision_cmd}}",
                    "allowed_exit": "0",
                    "is_super_user": false
                },
                "version": "2.1.3",
                "connector": "ssh",
                "operation": "run_remote_command",
                "ignore_errors": true,
                "operationTitle": "Execute remote command",
                "pickFromTenant": false,
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "465",
            "stepType": "/api/3/workflow_step_types/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "f58c71b4-816c-4a1d-a851-f67d0bec0b65"
        },
        {
            "@type": "WorkflowStep",
            "name": "Set Provisioning CMD",
            "description": null,
            "arguments": {
                "provision_cmd": "/usr/bin/bash /root/{{vars.input.records[0].vMType.itemValue|lower}}.sh {{vars.vm_name}} {{vars.vm_ip_address}} {{vars.cpu_cores}} {{vars.memory_mb}} {{vars.disk_gb}} {{vars.swap_mb}} {{vars.root_password}}"
            },
            "status": null,
            "top": "705",
            "left": "465",
            "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "39791b84-d705-4e0a-9cbe-048043a33c2b"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "route": "32d6f52e-8f2a-450f-973a-c56d566d4dc9",
                "resources": [
                    "v_m_instances"
                ],
                "__triggerLimit": true,
                "inputVariables": [],
                "step_variables": {
                    "input": {
                        "params": [],
                        "records": "{{vars.input.records}}"
                    },
                    "useMockOutput": "False",
                    "_update_records_env": "{%- if vars.input.params.vm_instance and vars.input.params.vm_instance | length > 0 -%}{{vars.input.records.append(vars.input.params.vm_instance)}}{%-endif-%}"
                },
                "triggerOnSource": true,
                "displayConditions": {
                    "v_m_instances": {
                        "sort": [],
                        "limit": 30,
                        "logic": "AND",
                        "filters": []
                    }
                },
                "executeButtonText": "Execute",
                "noRecordExecution": false,
                "showToasterMessage": {
                    "visible": false,
                    "messageVisible": true
                },
                "triggerOnReplicate": false,
                "singleRecordExecution": true
            },
            "status": null,
            "top": "30",
            "left": "300",
            "stepType": "/api/3/workflow_step_types/f414d039-bb0d-4e59-9c39-a8f1e880b18a",
            "group": null,
            "uuid": "ddf613c4-f071-4617-8431-e95140782d66"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update VM Instance Failure",
            "description": null,
            "arguments": {
                "resource": {
                    "logs": "<p>{{vars.cmd_result|replace('\\r\\n','&lt;br&gt;')}}</p>",
                    "status": "/api/3/picklists/3a009813-79af-4d41-8eeb-cec911d4821c"
                },
                "operation": "Append",
                "collection": "{{vars.input.records[0]['@id']}}",
                "__recommend": [],
                "collectionType": "/api/3/v_m_instances",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": {
                    "sdasdasd": "{{vars.steps.Run_Provisioning_CMD}}"
                }
            },
            "status": null,
            "top": "1245",
            "left": "125",
            "stepType": "/api/3/workflow_step_types/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "bd1c98fb-4bd1-4894-b59f-a9d5acae6e17"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update VM Instance Success",
            "description": null,
            "arguments": {
                "resource": {
                    "logs": "<p>{{vars.cmd_result|replace('\\r\\n','&lt;br&gt;')}}</p>",
                    "status": "/api/3/picklists/81dd9b98-c14d-4ef7-9e4d-22951c11958d"
                },
                "_showJson": false,
                "operation": "Append",
                "collection": "{{vars.input.records[0]['@id']}}",
                "__recommend": [],
                "collectionType": "/api/3/v_m_instances",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": {
                    "logs_result": "{{vars.steps.Run_Provisioning_CMD}}"
                }
            },
            "status": null,
            "top": "1245",
            "left": "475",
            "stepType": "/api/3/workflow_step_types/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "97cf4809-7922-4322-b4cd-b1d11b9c6afd"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Compute Available Resource -> Are Hardware Resources Enough",
            "targetStep": "/api/3/workflow_steps/a19a6a2b-df4b-4306-85ea-4a0f37402012",
            "sourceStep": "/api/3/workflow_steps/be041f7e-13b3-45be-b635-615bacaa0ab3",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "5d051482-0fd9-41f7-a156-9d450fb037b5"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Get Available Resources",
            "targetStep": "/api/3/workflow_steps/6ddbc282-5195-4ce0-9da9-c08de9541419",
            "sourceStep": "/api/3/workflow_steps/83a26daa-be4b-4fc6-85a4-2d0e218b0058",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "3cbbef6e-bda3-4605-a884-8b5f6ab747ef"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Deployment Successful -> Update VM Instance Failure",
            "targetStep": "/api/3/workflow_steps/bd1c98fb-4bd1-4894-b59f-a9d5acae6e17",
            "sourceStep": "/api/3/workflow_steps/20d7f4c6-b288-4fc7-bbf7-85ffe5a599cb",
            "label": "no",
            "isExecuted": false,
            "group": null,
            "uuid": "ec9e75c6-364d-4db2-bc7d-89eaf581f4a3"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Deployment Successful -> Update VM Instance Success",
            "targetStep": "/api/3/workflow_steps/97cf4809-7922-4322-b4cd-b1d11b9c6afd",
            "sourceStep": "/api/3/workflow_steps/20d7f4c6-b288-4fc7-bbf7-85ffe5a599cb",
            "label": "yes",
            "isExecuted": false,
            "group": null,
            "uuid": "53564d63-02b7-4a41-87ef-f686dcc27ea9"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Available Resources -> Compute Available Resource",
            "targetStep": "/api/3/workflow_steps/be041f7e-13b3-45be-b635-615bacaa0ab3",
            "sourceStep": "/api/3/workflow_steps/6ddbc282-5195-4ce0-9da9-c08de9541419",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "ccdaad49-68d0-46d4-ac55-3e4b9ff9da50"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get CMD Results -> Deployment Successful",
            "targetStep": "/api/3/workflow_steps/20d7f4c6-b288-4fc7-bbf7-85ffe5a599cb",
            "sourceStep": "/api/3/workflow_steps/3463c10e-af17-40cf-b06e-93b967652dc2",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "f7a98de7-6f78-4480-a3de-c856c452e3b4"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Proxmox Node Resources Available -> Set Provisioning Params",
            "targetStep": "/api/3/workflow_steps/39791b84-d705-4e0a-9cbe-048043a33c2b",
            "sourceStep": "/api/3/workflow_steps/a19a6a2b-df4b-4306-85ea-4a0f37402012",
            "label": "yes",
            "isExecuted": false,
            "group": null,
            "uuid": "ead37c17-6682-4f90-aa58-18d27c167d7c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Proxmox Node Resources Available -> Update VM Instance Failure",
            "targetStep": "/api/3/workflow_steps/bd1c98fb-4bd1-4894-b59f-a9d5acae6e17",
            "sourceStep": "/api/3/workflow_steps/a19a6a2b-df4b-4306-85ea-4a0f37402012",
            "label": "no",
            "isExecuted": false,
            "group": null,
            "uuid": "e3a22bdc-4527-4d02-b8ce-6fe28c9eb7a6"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Run Provisioning CMD -> Get CMD Results",
            "targetStep": "/api/3/workflow_steps/3463c10e-af17-40cf-b06e-93b967652dc2",
            "sourceStep": "/api/3/workflow_steps/f58c71b4-816c-4a1d-a851-f67d0bec0b65",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "388ee058-6aa7-4a4b-b56b-d6a8884b0d68"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Set Provisioning Params -> Copy of Get Available Resources",
            "targetStep": "/api/3/workflow_steps/f58c71b4-816c-4a1d-a851-f67d0bec0b65",
            "sourceStep": "/api/3/workflow_steps/39791b84-d705-4e0a-9cbe-048043a33c2b",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "3bc91159-18a0-4d3d-9f4c-245468c63d5d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "/api/3/workflow_steps/83a26daa-be4b-4fc6-85a4-2d0e218b0058",
            "sourceStep": "/api/3/workflow_steps/ddf613c4-f071-4617-8431-e95140782d66",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "781bb2b5-9eff-4027-b54e-dbe8c077cc2f"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update VM Instance Failure -> Notify Failure",
            "targetStep": "/api/3/workflow_steps/92940054-3698-4b5d-a027-bfb98f1c4e80",
            "sourceStep": "/api/3/workflow_steps/bd1c98fb-4bd1-4894-b59f-a9d5acae6e17",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "5a3b956a-9b02-4208-8777-fca140decc89"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update VM Instance Success -> Copy of Notify Failure",
            "targetStep": "/api/3/workflow_steps/03054abf-333f-40a5-b97e-f626d392ace9",
            "sourceStep": "/api/3/workflow_steps/97cf4809-7922-4322-b4cd-b1d11b9c6afd",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "9699e5e3-cae4-4e0f-8567-4f6e99b0962d"
        }
    ],
    "groups": [],
    "priority": "/api/3/picklists/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "playbookOrigin": "/api/3/picklists/15c1e8c9-22bf-4e66-8fbb-0a502d4a4a3f",
    "isEditable": true,
    "uuid": "73cc92fc-b6c0-4529-bd53-9b6b118ae94a",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Create"
    ]
}